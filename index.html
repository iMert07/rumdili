<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RUM TILI</title>
  <!-- Stil kısmını olduğu gibi koruyabilirsin, burayı kesiyorum -->
  <style>
    /* ... mevcut stil kodların ... */
  </style>
</head>
<body>
  <!-- ... mevcut body kısmı (başlık, arama kutusu vs.) ... -->

  <script>
    function normalizeString(str) {
      if (!str) return '';
      return str.normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ı/g, 'ı')
                .replace(/İ/g, 'i')
                .toLowerCase();
    }

    const turkishOrder = [
      'a', 'b', 'c', 'ç', 'd', 'e', 'f', 'g', 'ğ', 'h',
      'ı', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'ö', 'p',
      'r', 's', 'ş', 't', 'u', 'ü', 'v', 'x', 'y', 'z'
    ];

    function customTurkishCompare(a, b) {
      const aStr = normalizeString(a);
      const bStr = normalizeString(b);
      const minLength = Math.min(aStr.length, bStr.length);

      for (let i = 0; i < minLength; i++) {
        const aChar = aStr[i];
        const bChar = bStr[i];

        const aIndex = turkishOrder.indexOf(aChar);
        const bIndex = turkishOrder.indexOf(bChar);

        if (aIndex !== bIndex) return aIndex - bIndex;
      }

      return aStr.length - bStr.length;
    }

    let allWords = [];
    let lastSelectedWord = null;
    let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];

    async function fetchWords() {
      const sheetId = '1R01aIajx6dzHlO-KBiUXUmld2AEvxjCQkUTFGYB3EDM';
      const sheetName = 'Sözlük';
      const url = `https://opensheet.elk.sh/${sheetId}/${sheetName}`;

      try {
        const response = await fetch(url);
        allWords = await response.json();
        setupSearch();
      } catch (error) {
        console.error('VERİ ÇEKME HATASI:', error);
        document.getElementById('result').innerHTML =
          '<p style="color: red;">VERİLER YÜKLENİRKEN HATA OLUŞTU. LÜTFEN SAYFAYI YENİLEYİN.</p>';
      }
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const suggestionsDiv = document.getElementById('suggestions');
      displaySearchHistory();

      searchInput.addEventListener('input', function () {
        const rawQuery = this.value.trim();
        const query = normalizeString(rawQuery);
        if (!query) {
          suggestionsDiv.innerHTML = '';
          if (lastSelectedWord) showResult(lastSelectedWord);
          displaySearchHistory();
          return;
        }

        const matches = allWords.filter(row => {
          const wordRaw = row.Sözcük || '';
          const wordNorm = normalizeString(wordRaw);
          const matchWord = wordNorm.startsWith(query);
          const synonyms = row['Eş Anlamlılar']
            ? row['Eş Anlamlılar'].split(',').map(s => normalizeString(s.trim()))
            : [];
          const matchSynonym = synonyms.some(s => s.startsWith(query));
          return matchWord || matchSynonym;
        });

        displaySuggestions(matches, query);
      });

      searchInput.addEventListener('focus', () => {
        if (!searchInput.value.trim()) displaySearchHistory();
      });

      searchInput.addEventListener('blur', () => {
        setTimeout(() => document.getElementById('suggestions').innerHTML = '', 100);
      });

      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const firstSuggestion = suggestionsDiv.querySelector('.suggestion');
          if (firstSuggestion) firstSuggestion.click();
        }
      });
    }

    function displaySuggestions(matches, query) {
      const suggestionsDiv = document.getElementById('suggestions');
      suggestionsDiv.innerHTML = '';
      if (matches.length === 0) {
        suggestionsDiv.innerHTML = '<div class="suggestion">Sonuç bulunamadı</div>';
        return;
      }

      matches.sort((a, b) => {
        const aMatched = normalizeString(a.Sözcük).startsWith(query)
          ? a.Sözcük
          : (a['Eş Anlamlılar'] || '').split(',').find(s => normalizeString(s.trim()).startsWith(query)) || '';

        const bMatched = normalizeString(b.Sözcük).startsWith(query)
          ? b.Sözcük
          : (b['Eş Anlamlılar'] || '').split(',').find(s => normalizeString(s.trim()).startsWith(query)) || '';

        const primaryCompare = customTurkishCompare(aMatched, bMatched);
        if (primaryCompare !== 0) return primaryCompare;

        return customTurkishCompare(a.Sözcük, b.Sözcük);
      }).slice(0, 12).forEach(match => {
        const suggestion = document.createElement('div');
        suggestion.className = 'suggestion';

        const word = match.Sözcük;
        const synonyms = match['Eş Anlamlılar']
          ? match['Eş Anlamlılar'].split(',').map(x => x.trim())
          : [];

        const matchedSynonym = !normalizeString(match.Sözcük).startsWith(query)
          ? synonyms.find(syn => normalizeString(syn).startsWith(query))
          : null;

        suggestion.innerHTML = `
          <span class="main-word">${matchedSynonym || word}</span>
          ${matchedSynonym ? `<span class="synonym-hint">${word}</span>` : ''}
        `;
        suggestion.addEventListener('click', () => selectWord(match));
        suggestionsDiv.appendChild(suggestion);
      });
    }

    // Geri kalan kod (selectWord, showResult, clearResult, updateSearchHistory vs.) aynı şekilde kalabilir.

    fetchWords();
  </script>
</body>
</html>
